/*
 * generated by Xtext 2.11.0
 */
package org.xtext.de.htwg.generator

import org.eclipse.emf.ecore.resource.Resource
import org.eclipse.xtext.generator.AbstractGenerator
import org.eclipse.xtext.generator.IFileSystemAccess2
import org.eclipse.xtext.generator.IGeneratorContext
import org.xtext.de.htwg.phases.Game
import org.xtext.de.htwg.phases.Phase

/**
 * Generates code from your model files on save.
 * 
 * See https://www.eclipse.org/Xtext/documentation/303_runtime_concepts.html#code-generation
 */
class PhasesGenerator extends AbstractGenerator {

	String phaseType = "null"
	String numbersTypes = "null"
	String numberColors = "null"
	String streetLenght = "null"
	String firstNumType;
	String secNumType;
	int biggestNumType;
	
	override void doGenerate(Resource resource, IFileSystemAccess2 fsa, IGeneratorContext context) {
		val game = resource.contents.head as Game
		
		for(Phase phase : game.phases){
			phaseType = "null"
			numbersTypes = "null"
			numberColors = "null"
			streetLenght = "null"
			
			if(phase.phaseType.numbersType != null){
		    	phaseType = phase.phaseType.numbersType.name.toString;
		    	numbersTypes = phase.phaseType.numbersType.numbersType.toString;
		    	firstNumType = phase.phaseType.numbersType.numbersType.get(0);
		    	secNumType = phase.phaseType.numbersType.numbersType.get(1);
		    	if(firstNumType == "QUADRUPLE" || secNumType == "QUADRUPLE") {
		    		biggestNumType = 4;
		    	} else if(firstNumType == "TRIPLE" || secNumType == "TRIPLE") {
		    		biggestNumType = 3;
		    	} else {
		    		biggestNumType = 2;
		    	}
		    }
		    if(phase.phaseType.colorType != null){
		    	phaseType = phase.phaseType.colorType.name.toString;
		    	numberColors = phase.phaseType.colorType.numberColors.toString;
		    	
		    }
		    if(phase.phaseType.streetType != null){
		    	phaseType = phase.phaseType.streetType.name.toString;
		    	streetLenght = phase.phaseType.streetType.streetLenght.toString;
		    }
		    
			fsa.generateFile('Phase'+phase.phaseNumber+'.java', 
			'''
package model.phase.impl;
import model.deck.IDeckOfCards;
import model.phase.DeckNotFitException;
import model.phase.IPhase;
import model.stack.ICardStack;
import java.util.List;

/**
 * Created by Tarek on 24.09.2015. Be grateful for this superior Code!
 *
 * edited: Konraifen88
 * date: 30.09.2015
 * merged phase checker and getter
 * edited: daschwin
 * date: 20.07.2017
 * to be generated
 */
public class Phase«phase.phaseNumber» implements IPhase {

    public static final int PHASE_NUMBER = «phase.phaseNumber»;
	private static final String DESCRIPTION_PHASE = "«phase.phaseDescription»";
    «IF	phaseType	==	"NUMBERS"»
	private static final String DOUBLE = "DOUBLE";
	private static final String TRIPLE = "TRIPLE";
	private static final String QUADRUPLE = "QUADRUPLE";
	private String[] numbersTypes=«numbersTypes»;
    	«IF firstNumType == "DOUBLE"»
	private IPhaseChecker firstChecker = new ValueChecker(2); 
    	«ENDIF»
    	«IF firstNumType == "TRIPLE"»
	private IPhaseChecker firstChecker = new ValueChecker(3);
		«ENDIF»
		«IF firstNumType == "QUADRUPLE"»
	private IPhaseChecker firstChecker = new ValueChecker(4);
		«ENDIF»
		«IF secNumType == "DOUBLE"»
	private IPhaseChecker secondChecker = new ValueChecker(2); 
    	«ENDIF»
    	«IF secNumType == "TRIPLE"»
	private IPhaseChecker secondChecker = new ValueChecker(3);
		«ENDIF»
		«IF secNumType == "QUADRUPLE"»
	private IPhaseChecker secondChecker = new ValueChecker(4);
		«ENDIF»
	private IPhaseSplitter phaseSplitter = new DeckSplitter(«biggestNumType», new CardValueComparator());
    «ENDIF»	
    «IF	phaseType	==	"COLORS"»
    private Integer numberColors = «numberColors»;
    private IPhaseChecker phaseChecker;
    «ENDIF»
    «IF	phaseType	==	"STREET"»
    private Integer streetLenght = «streetLenght»;
    private IPhaseChecker phaseChecker;
    «ENDIF»
    
    
    public Phase«phase.phaseNumber»() {
    «IF	phaseType	==	"STREET"»
    phaseChecker = new StreetChecker(streetLenght);
    «ENDIF»
    «IF	phaseType	==	"COLORS"»
        phaseChecker = new ColorChecker(numberColors);
    «ENDIF»
    }

    @Override
    public String getDescription() {
        return DESCRIPTION_PHASE;
    }

    @Override
    public List<ICardStack> splitAndCheckPhase(IDeckOfCards phase) throws DeckNotFitException {
			«IF	phaseType	==	"NUMBERS"»
	List<IDeckOfCards> splitted = phaseSplitter.split(phase);
	if (firstChecker.check(splitted.get(0)) && secondChecker.check(splitted.get(1)) ) {
    	return Arrays.asList(new PairStack(splitted.get(0)), new PairStack(splitted.get(1)));
	}
	throw new DeckNotFitException();
			«ENDIF»	
			«IF	phaseType	==	"COLORS"»
				if (phaseChecker.check(phase)) {
				    return Collections.singletonList(new ColorStack(phase));
				}
				throw new DeckNotFitException();
			«ENDIF»	
			«IF	phaseType	==	"STREET"»
				if (phaseChecker.check(phase)) {
					return Collections.singletonList(new StreetStack(phase));
				}
				throw new DeckNotFitException();
			«ENDIF»	
    }

    @Override
    public IPhase getNextPhase() {
    	«IF	phase.phaseNumber < 5»
    	return new Phase«phase.phaseNumber + 1»();
    	«ENDIF»
    	«IF	phase.phaseNumber >= 5»
    	return new Phase5();
    	«ENDIF»	
    }

    @Override
    public int getPhaseNumber() {
    	return PHASE_NUMBER;
    }

    @Override
    public boolean isNumberPhase() {
    	«IF	phaseType	==	"NUMBERS"»
    	return true;
    	«ENDIF»
    	«IF	phaseType	!=	"NUMBERS"»
    	return false;
    	«ENDIF»
    }

    @Override
    public String toString() {
        return "Phase" + PHASE_NUMBER;
    }
}
''')
			
		}
	}
}
